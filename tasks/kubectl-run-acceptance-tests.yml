platform: linux

image_resource:
  type: docker-image
  source:
    repository: eu.gcr.io/census-gcr/gcloud-kubectl

params:
  SERVICE_ACCOUNT_JSON:
  GCP_PROJECT_NAME:
  KUBERNETES_CLUSTER:
  ACCEPTANCE_TESTS_IMAGE:
  UNADDRESSED_YAML:

inputs:
- name: acceptance-tests-repo

run:
  path: bash
  args:
    - -exc
    - |
      cat >~/gcloud-service-key.json <<EOL
      $SERVICE_ACCOUNT_JSON
      EOL

      # Use gcloud service account to configure kubectl
      gcloud auth activate-service-account --key-file ~/gcloud-service-key.json
      gcloud container clusters get-credentials ${KUBERNETES_CLUSTER} --zone europe-west2 --project ${GCP_PROJECT_NAME}

      # Run acceptance tests for unaddressed batch
      kubectl apply -f ${UNADDRESSED_YAML}
      sleep 10
      OUTPUT=$(kubectl exec -it qid-batch-runner-experiment -- /app/run_acceptance_tests.sh)
      echo The output is $OUTPUT
      kubectl delete -f ${UNADDRESSED_YAML}
      TEST_RESULT=${OUTPUT: -16}
      echo $TEST_RESULT > ~/test_result.txt
      egrep "TESTS PASSED" ~/test_result.txt
